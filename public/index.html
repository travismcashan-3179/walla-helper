<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WallaWords Helper</title>
  <!-- Include Papa Parse from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* Reset & Base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #fafafa;
      color: #333;
      padding: 20px;
    }
    h2 { 
      text-align: center; 
      font-weight: 700; 
      font-size: 1.6rem; 
      margin-bottom: 20px; 
    }
    /* Three-column layout */
    #mainContainer {
      display: flex;
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .column {
      flex: 1;
      min-width: 250px;
    }
    /* Left Column: Grid */
    #gridContainer {
      margin-bottom: 20px;
    }
    #wordGrid {
      border-collapse: collapse;
      width: 100%;
    }
    #wordGrid td {
      vertical-align: middle;
      text-align: center;
      border: 2px solid #333;
      width: 100px;
      height: 100px;
      background: #fff;
      padding: 4px;
    }
    .cellContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #wordGrid input {
      width: 90%;
      height: 50%;
      font-size: 1rem;
      font-weight: bold;
      text-align: center;
      border: none;
      background: transparent;
      outline: none;
    }
    /* Middle Column: Sentences & Word Details */
    #sentencesPanel, #wordDetailsPanel {
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
    }
    #sentencesPanel {
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    .sentence-group { margin-bottom: 15px; }
    .sentence-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 5px; }
    .sentencesText { white-space: pre-wrap; font-size: 1rem; line-height: 1.4; }
    #verticalSentences ol,
    #horizontalSentences ol {
      margin-left: 20px;
    }
    /* Right Column: AI Helper Analysis */
    #aiAnalyzerPanel {
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
      min-height: 200px;
    }
    #aiAnalyzerPanel h3 {
      text-align: center;
      margin-bottom: 10px;
    }
    /* Button styles */
    button {
      display: inline-block;
      margin: 10px 5px;
      padding: 8px 16px;
      font-size: 1rem;
      cursor: pointer;
    }
    /* Tag styling for synonyms */
    .tag {
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 2px 4px;
      margin: 2px;
      cursor: pointer;
      background-color: #eee;
      font-size: 0.9rem;
    }
    /* Word Type Display: light grey text */
    .wordTypeDisplay {
      font-size: 0.8rem;
      color: #aaa;
      text-align: center;
      margin-top: 4px;
    }
    /* Footer */
    footer {
      margin-top: 40px;
      text-align: center;
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>WallaWords Helper</h2>
  
  <div id="mainContainer">
    <!-- Left Column: Grid -->
    <div class="column" id="gridContainer">
      <table id="wordGrid">
        <tbody>
          <!-- Grid rows generated by JS -->
        </tbody>
      </table>
      <button id="clearGridButton" onclick="clearGrid()">Clear Grid</button>
    </div>
    
    <!-- Middle Column: Sentences & Word Details -->
    <div class="column">
      <div id="sentencesPanel">
        <div class="sentence-group">
          <div class="sentence-title">Vertical Sentences</div>
          <div id="verticalSentences" class="sentencesText"></div>
        </div>
        <div class="sentence-group">
          <div class="sentence-title">Horizontal Sentences</div>
          <div id="horizontalSentences" class="sentencesText"></div>
        </div>
      </div>
      <div id="wordDetailsPanel">
        <strong>Word Details:</strong> Double-click a word tile to view details.
        <!-- The "Analyze Word" button is moved here -->
        <br><button onclick="analyzeWord(selectedCell)">Analyze Word</button>
      </div>
    </div>
    
    <!-- Right Column: AI Helper Analysis Panel with Q&A -->
    <div class="column" id="aiAnalyzerPanel">
      <h3>AI Helper Analysis</h3>
      <!-- Text field for asking questions -->
      <input type="text" id="aiQuestion" placeholder="Ask ChatGPT a question" style="width:90%; padding:8px; margin-bottom:10px;">
      <button onclick="askQuestion()">Ask ChatGPT</button>
      <div id="openaiAnalysis"></div>
    </div>
  </div>
  
  <footer>
    <p>
      Instructions: Enter words into the grid (each cell is 100×100px). Your input is automatically saved.
      Vertical sentences (with punctuation removed) and horizontal sentences (preserving punctuation) are generated in the middle column.
      Double-click a cell to view its word details.
      In the Word Details panel, synonyms (generated via ChatGPT) are displayed as clickable tags—double-click a tag to replace the word.
      Use the "Analyze Word" button (below the Word Details) to get AI analysis for the selected word.
      In the AI Helper Analysis panel, ask any question to ChatGPT using the text field.
    </p>
  </footer>
  
  <script>
    let selectedCell = null; // Stores the currently selected grid cell.
    const rows = 5, cols = 3;
    const tableBody = document.querySelector('#wordGrid tbody');
    let frequencyData = [];
    let verticalSentencesArray = [];
    let horizontalSentencesArray = [];
    
    // --- Get Top Variants from CSV Data (unused, variants removed) ---
    function getTopVariants(pos, currentLemma) {
      let variants = frequencyData
        .filter(entry => entry.POS.toLowerCase() === pos.toLowerCase() && entry.LEMMA.toLowerCase() !== currentLemma.toLowerCase())
        .sort((a, b) => Number(b.FREQUENCY) - Number(a.FREQUENCY))
        .slice(0, 10)
        .map(entry => entry.LEMMA);
      return variants;
    }
    
    // --- Helper: Clean a Word for CSV lookup ---
    function cleanWord(word) {
      return word.replace(/^[\.,!?;:\(\)]+|[\.,!?;:\(\)]+$/g, "");
    }
    
    // --- Load CSV Data using Papa Parse ---
    function loadFrequencyData() {
      Papa.parse("wordlist.csv", {
        download: true,
        header: true,
        complete: function(results) {
          frequencyData = results.data;
          console.log("Frequency data loaded:", frequencyData);
          updateWordTypes();
        },
        error: function(err) {
          console.error("Error loading CSV:", err);
        }
      });
    }
    loadFrequencyData();
    
    // --- Build Grid Dynamically & Load Saved Values ---
    for (let r = 0; r < rows; r++) {
      const tr = document.createElement('tr');
      for (let c = 0; c < cols; c++) {
        const td = document.createElement('td');
        const container = document.createElement('div');
        container.className = "cellContainer";
        const input = document.createElement('input');
        input.type = 'text';
        input.id = `cell-${r}-${c}`;
        input.value = localStorage.getItem(input.id) || '';
        input.addEventListener('input', () => {
          localStorage.setItem(input.id, input.value);
          updateSentences();
        });
        // On double-click, set selected cell and populate word details.
        input.addEventListener('dblclick', () => {
          selectedCell = input;
          populateWordDetails(input);
        });
        container.appendChild(input);
        let typeDisplay = document.getElementById(`type-${r}-${c}`);
        if (!typeDisplay) {
          typeDisplay = document.createElement('div');
          typeDisplay.className = "wordTypeDisplay";
          typeDisplay.id = `type-${r}-${c}`;
          container.appendChild(typeDisplay);
        }
        td.appendChild(container);
        tr.appendChild(td);
      }
      tableBody.appendChild(tr);
    }
    
    // --- Clear Grid Function ---
    function clearGrid() {
      document.querySelectorAll("#wordGrid input").forEach(cell => {
        cell.value = "";
        localStorage.removeItem(cell.id);
      });
      updateSentences();
    }
    
    // --- Replace Selected Cell with New Word ---
    function replaceSelectedCell(newWord) {
      if (selectedCell) {
        selectedCell.value = newWord;
        localStorage.setItem(selectedCell.id, newWord);
        updateSentences();
        populateWordDetails(selectedCell);
      }
    }
    
    // --- Fetch Synonyms using ChatGPT via Proxy ---
    async function fetchSynonymsGPT(word) {
      const prompt = `Provide 10 synonyms for the word "${word}" without explanation, separated by commas.`;
      try {
        const response = await fetch("http://localhost:3000/openai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await response.json();
        if (data.choices && data.choices.length > 0) {
          const result = data.choices[0].message.content;
          return result.split(",").map(s => s.trim()).filter(s => s.length > 0);
        } else {
          return [];
        }
      } catch (err) {
        console.error("Error fetching synonyms with GPT:", err);
        return [];
      }
    }
    
    // --- Populate Word Details Panel ---
    async function populateWordDetails(cell) {
      const rawWord = cell.value.trim();
      const word = cleanWord(rawWord);
      const detailsPanel = document.getElementById("wordDetailsPanel");
      if (!word) {
        detailsPanel.innerHTML = "<strong>Word Details:</strong> No word selected.";
        return;
      }
      let entry = frequencyData.find(entry => entry.LEMMA.toLowerCase() === word.toLowerCase());
      if (!entry) {
        entry = frequencyData.find(entry => {
          if (entry.INFLECTIONS) {
            return entry.INFLECTIONS.toLowerCase().split(/,\s*/).includes(word.toLowerCase());
          }
          return false;
        });
      }
      let pos, frequency, inflections;
      if (entry) {
        switch(entry.POS.toLowerCase()){
          case "v": pos = "verb"; break;
          case "fw": pos = "function word"; break;
          case "n": pos = "noun"; break;
          case "r": pos = "adverb"; break;
          case "j": pos = "adjective"; break;
          case "u": pos = "interjection"; break;
          case "m": pos = "numeral"; break;
          case "k": pos = "proper noun"; break;
          case "abbr": pos = "abbreviation"; break;
          default: pos = entry.POS;
        }
        frequency = entry.FREQUENCY;
        inflections = entry.INFLECTIONS;
      } else {
        pos = "[unknown]";
        frequency = "[unknown]";
        inflections = "[unknown]";
      }
      
      detailsPanel.innerHTML = `<h3><strong>${word}</strong></h3>
<ul style="margin-left:20px;">
  <li><strong>Part of Speech:</strong> ${pos}</li>
  <li><strong>Frequency:</strong> ${frequency}</li>
  <li><strong>Inflections:</strong> ${inflections}</li>
</ul>
<div><strong>Synonyms:</strong> <span id="synonymsPlaceholder">Loading...</span></div>`;
      
      // Fetch synonyms via ChatGPT proxy.
      const synonyms = await fetchSynonymsGPT(word);
      let synonymsHTML = "";
      if (synonyms.length > 0) {
        synonymsHTML = synonyms.map(syn => `<span class="tag" ondblclick="replaceSelectedCell('${syn}')">${syn}</span>`).join(" ");
      } else {
        synonymsHTML = "None available";
      }
      document.getElementById("synonymsPlaceholder").innerHTML = synonymsHTML;
    }
    
    // --- Analyze Word with OpenAI via Proxy ---
    async function analyzeWord(cell) {
      if (!cell) return;
      const rawWord = cell.value.trim();
      const word = cleanWord(rawWord);
      const parts = cell.id.split("-");
      const rowIndex = parseInt(parts[1]);
      const colIndex = parseInt(parts[2]);
      
      function getRowSentence(r) {
        let rowArr = [];
        for (let c = 0; c < cols; c++) {
          rowArr.push(document.getElementById(`cell-${r}-${c}`).value.trim());
        }
        return rowArr.join(" ");
      }
      function getColumnSentence(c) {
        let colArr = [];
        for (let r = 0; r < rows; r++) {
          colArr.push(document.getElementById(`cell-${r}-${c}`).value.trim());
        }
        return colArr.join(" ");
      }
      
      const horizontalSentence = getRowSentence(rowIndex);
      const verticalSentence = getColumnSentence(colIndex);
      
      const prompt = `Analyze the word "${word}" in the following contexts:
Vertical sentence: "${verticalSentence}"
Horizontal sentence: "${horizontalSentence}"
Provide a brief summary of your thoughts about the word in these contexts, then list 3-5 alternative word suggestions under the heading "Alternatives:" to improve both sentences.`;
      
      // Show loading indicator in the Word Details panel's analysis area.
      const analysisDiv = document.getElementById("openaiAnalysis");
      analysisDiv.innerHTML = "<em>Analyzing...</em>";
      
      try {
        const response = await fetch("http://localhost:3000/openai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await response.json();
        if (data.choices && data.choices.length > 0) {
          analysisDiv.innerHTML = `<strong>OpenAI Analysis:</strong><br>${data.choices[0].message.content.replace(/\n/g, "<br>")}`;
        } else {
          analysisDiv.innerHTML = "<strong>OpenAI Analysis:</strong><br>No response returned.";
        }
      } catch (error) {
        console.error("Error calling OpenAI API:", error);
        analysisDiv.innerHTML = "<strong>OpenAI Analysis:</strong><br>Error calling API.";
      }
    }
    
    // --- Update All Word Types ---
    function updateWordTypes() {
      document.querySelectorAll("#wordGrid input").forEach(cell => {
        updateWordType(cell);
      });
    }
    
    // --- Update Word Type for a Cell using CSV Data ---
    function updateWordType(cell) {
      let word = cell.value.trim();
      word = cleanWord(word);
      const display = document.getElementById("type-" + cell.id.split("-").slice(1).join("-"));
      if (!word) {
        if (display) display.innerText = "";
        return;
      }
      let entry = frequencyData.find(entry => entry.LEMMA.toLowerCase() === word.toLowerCase());
      if (!entry) {
        entry = frequencyData.find(entry => {
          if (entry.INFLECTIONS) {
            return entry.INFLECTIONS.toLowerCase().split(/,\s*/).includes(word.toLowerCase());
          }
          return false;
        });
      }
      if (entry) {
        let full;
        switch(entry.POS.toLowerCase()){
          case "v": full = "verb"; break;
          case "fw": full = "function word"; break;
          case "n": full = "noun"; break;
          case "r": full = "adverb"; break;
          case "j": full = "adjective"; break;
          case "u": full = "interjection"; break;
          case "m": full = "numeral"; break;
          case "k": full = "proper noun"; break;
          case "abbr": full = "abbreviation"; break;
          default: full = entry.POS;
        }
        display.innerText = `[${full}]`;
      } else {
        display.innerText = "[unknown]";
      }
    }
    
    // --- Update Sentences ---
    function updateSentences() {
      let grid = [];
      for (let r = 0; r < rows; r++) {
        let rowArr = [];
        for (let c = 0; c < cols; c++) {
          let val = document.getElementById(`cell-${r}-${c}`).value.trim();
          rowArr.push(val);
        }
        grid.push(rowArr);
      }
      
      // Vertical sentences: each column (top-to-bottom), remove punctuation.
      verticalSentencesArray = [];
      for (let c = 0; c < cols; c++) {
        let colWords = [];
        for (let r = 0; r < rows; r++) {
          let word = grid[r][c] || "____";
          word = word.replace(/[\.,!?;:]+/g, "");
          colWords.push(word);
        }
        verticalSentencesArray.push(colWords.join(" "));
      }
      
      // Horizontal sentences: join all cells (preserving punctuation) and split.
      const flatWords = grid.flat().filter(word => word !== "");
      let horizontalText = flatWords.join(" ");
      if (!horizontalText) horizontalText = "____";
      horizontalSentencesArray = splitIntoSentences(horizontalText);
      
      const verticalHTML = "<ol>" + verticalSentencesArray.map(sentence => `<li>${sentence}</li>`).join("") + "</ol>";
      const horizontalHTML = "<ol>" + horizontalSentencesArray.map(sentence => `<li>${sentence}</li>`).join("") + "</ol>";
      
      document.getElementById("verticalSentences").innerHTML = verticalHTML;
      document.getElementById("horizontalSentences").innerHTML = horizontalHTML;
      
      updateWordTypes();
    }
    
    // --- Split Text into Sentences Based on Punctuation (. ? !)
    function splitIntoSentences(text) {
      text = text.trim();
      if (!text) return [];
      return text.split(/(?<=[.!?])\s+/);
    }
    
    // --- General Q&A: Ask ChatGPT a question from the AI Analyzer panel ---
    async function askQuestion() {
      const questionField = document.getElementById("aiQuestion");
      const question = questionField.value.trim();
      if (!question) return;
      const analysisDiv = document.getElementById("openaiAnalysis");
      analysisDiv.innerHTML = "<em>Processing question...</em>";
      
      try {
        const response = await fetch("http://localhost:3000/openai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: question })
        });
        const data = await response.json();
        if (data.choices && data.choices.length > 0) {
          analysisDiv.innerHTML = `<strong>Answer:</strong><br>${data.choices[0].message.content.replace(/\n/g, "<br>")}`;
        } else {
          analysisDiv.innerHTML = "<strong>Answer:</strong><br>No response returned.";
        }
      } catch (error) {
        console.error("Error asking question:", error);
        analysisDiv.innerHTML = "<strong>Answer:</strong><br>Error calling API.";
      }
    }
    
    // --- Run on Load ---
    updateSentences();
  </script>
  
</body>
</html>
